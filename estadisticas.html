<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estadísticas Secretarios - Sistema Real</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background-color: var(--light-color); color: var(--dark-color); }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        
        .global-controls {
            display: flex; justify-content: space-between; margin-bottom: 20px;
            background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .date-selector { display: flex; gap: 10px; align-items: center; }
        select { padding: 8px; border-radius: 5px; border: 1px solid #bdc3c7; }
        
        .chart-type-btn { padding: 8px 15px; border: 1px solid #bdc3c7; background: white; cursor: pointer; border-radius: 5px; }
        .chart-type-btn.active { background: var(--secondary-color); color: white; border-color: var(--secondary-color); }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 20px; }
        .chart-card { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .chart-total { font-weight: bold; background: var(--accent-color); color: white; padding: 5px 12px; border-radius: 15px; }
        .chart-container { height: 300px; position: relative; }
        
        .loading { text-align: center; padding: 50px; font-size: 1.2rem; }
        
        /* Estilos para impresión */
        .print-btn { padding: 8px 15px; border: 1px solid #bdc3c7; background: #2ecc71; color: white; cursor: pointer; border-radius: 5px; margin-left: 10px; }
        #printModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 1000; overflow: auto; }
        .print-content { background-color: white; margin: 5% auto; padding: 20px; width: 90%; max-width: 1000px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .print-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #bdc3c7; padding-bottom: 10px; }
        .print-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        .print-table th, .print-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .print-table th { background-color: #f2f2f2; font-weight: bold; }
        .print-section { margin-bottom: 30px; }
        .print-section h3 { color: var(--primary-color); margin-bottom: 10px; border-bottom: 1px solid #bdc3c7; padding-bottom: 5px; }
        .close-btn { background-color: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .print-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="global-controls">
            <div class="date-selector">
                <span>Filtro:</span>
                <select id="globalMonthSelector">
                    <option value="0">Todos los meses</option>
                    <option value="1">Enero</option><option value="2">Febrero</option><option value="3">Marzo</option>
                    <option value="4">Abril</option><option value="5">Mayo</option><option value="6">Junio</option>
                    <option value="7">Julio</option><option value="8">Agosto</option><option value="9">Septiembre</option>
                    <option value="10">Octubre</option><option value="11">Noviembre</option><option value="12">Diciembre</option>
                </select>
                <select id="globalYearSelector">
                    <option value="0">Todos los años</option>
                </select>
            </div>
            <div style="display: flex; gap: 10px;">
                <div class="chart-type-selector">
                    <button class="chart-type-btn active" data-type="circular">Circular</button>
                    <button class="chart-type-btn" data-type="lineal">Lineal</button>
                </div>
                <button id="printBtn" class="print-btn">Imprimir Informe</button>
            </div>
        </div>

        <div id="loading" class="loading">Cargando estadísticas reales...</div>
        <div id="statsGrid" class="stats-grid" style="display: none;"></div>
    </div>

    <!-- Modal para imprimir -->
    <div id="printModal">
        <div class="print-content">
            <div class="print-header">
                <h2>Informe de Estadísticas</h2>
                <button class="close-btn" id="closePrintModal">Cerrar</button>
            </div>
            <div id="printData">
                <!-- Los datos de impresión se generarán aquí -->
            </div>
            <div class="print-actions">
                <button class="print-btn" id="doPrint">Imprimir</button>
                <button class="close-btn" id="cancelPrint">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURACIÓN SDK FIREBASE (ORIGINAL DE TU ARCHIVO)
        const firebaseConfig = {
            apiKey: "AIzaSyDhRdnI7u6fBBH9A5h31Y9WnDNopkZOlgE",
            authDomain: "secretarios-def3.firebaseapp.com",
            projectId: "secretarios-def3",
            storageBucket: "secretarios-def3.firebasestorage.app",
            messagingSenderId: "522102845445",
            appId: "1:522102845445:web:bfdf7c211d8efad1a2ac6c"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let causasData = [], miscausasData = [], clientesData = [];
        let globalMonth = 0;
        let globalYear = 0; // Inicializar en 0 para "Todos los años"
        let chartType = 'circular';
        let charts = {};
        let currentStats = {};

        const colorPalette = [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', 
            '#7CFFB2', '#C9CBCF', '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0'
        ];

        async function cargarDatos() {
            try {
                console.log("Iniciando carga de datos...");
                
                // Registro del plugin de etiquetas para Chart.js
                Chart.register(ChartDataLabels);

                const [causasSnap, miscausasSnap, clientesSnap] = await Promise.all([
                    db.collection('causas').get(),
                    db.collection('miscausas').get(),
                    db.collection('clientes').get()
                ]);

                causasData = causasSnap.docs.map(doc => doc.data());
                miscausasData = miscausasSnap.docs.map(doc => doc.data());
                clientesData = clientesSnap.docs.map(doc => doc.data());

                console.log("Datos cargados:", {
                    causas: causasData.length,
                    miscausas: miscausasData.length,
                    clientes: clientesData.length
                });

                document.getElementById('loading').style.display = 'none';
                document.getElementById('statsGrid').style.display = 'grid';
                
                rellenarAnios();
                procesarYMostrarDatos();
            } catch (error) {
                console.error("Error:", error);
                document.getElementById('loading').innerText = "Error al conectar con Firebase: " + error.message;
            }
        }

        function rellenarAnios() {
            const selector = document.getElementById('globalYearSelector');
            const actual = new Date().getFullYear();
            
            // Agregar opción "Todos los años" si no existe
            if (selector.querySelector('option[value="0"]')) {
                selector.innerHTML = '<option value="0">Todos los años</option>';
            }
            
            for(let i = actual - 2; i <= actual + 1; i++) {
                let opt = document.createElement('option');
                opt.value = i; 
                opt.text = i;
                if(i === actual) opt.selected = true;
                selector.add(opt);
            }
            
            // Establecer el año actual
            globalYear = actual;
        }

        function obtenerMesYAnio(fechaStr) {
            if (!fechaStr || fechaStr === "") {
                console.log("Fecha vacía o nula:", fechaStr);
                return null;
            }
            
            try {
                let fecha = new Date(fechaStr);
                if (!isNaN(fecha.getTime())) {
                    return {
                        mes: fecha.getMonth() + 1,
                        anio: fecha.getFullYear()
                    };
                } else {
                    console.log("Fecha inválida:", fechaStr);
                    return null;
                }
            } catch (e) {
                console.error('Error procesando fecha:', fechaStr, e);
                return null;
            }
        }

        function filtroFecha(fechaInfo) {
            // Si no hay filtro seleccionado (mes=0, año=0), mostrar todo
            if (globalMonth === 0 && globalYear === 0) {
                return true;
            }
            
            // Si no tenemos información de fecha, no mostrar (excepto si no hay filtro)
            if (!fechaInfo) {
                return false;
            }
            
            const coincideMes = globalMonth === 0 || fechaInfo.mes === globalMonth;
            const coincideAnio = globalYear === 0 || fechaInfo.anio === globalYear;
            
            return coincideMes && coincideAnio;
        }

        function procesarYMostrarDatos() {
            console.log("Procesando datos con filtros - Mes:", globalMonth, "Año:", globalYear);
            
            currentStats = {
                "Empleados": procesarPorEmpleado(),
                "Audiencias": procesarPorAudiencias(),
                "Vencimientos": procesarPorVencimientos(),
                "Actividades": procesarPorActividades(),
                "Tipos de Proceso": procesarPorCausas(),
                "Modo Intervención": procesarPorControl(),
                "Prioridades": procesarPorPrioridades(),
                "Firma Digital": procesarPorFirmaDigital(),
                "Clientes": procesarPorClientes()
            };
            
            console.log("Datos procesados:", currentStats);
            mostrarEstadisticas(currentStats);
        }

        function procesarPorEmpleado() {
            const empleados = {};
            let contador = 0;
            
            [...causasData, ...miscausasData].forEach(doc => {
                // Usar fechaActualizacion como referencia
                const fechaRef = doc.fechaActualizacion || doc.fechaHora || new Date().toISOString();
                const fechaInfo = obtenerMesYAnio(fechaRef);
                
                if (filtroFecha(fechaInfo)) {
                    const empleado = doc.empleadoAsignado || doc.empleado || "No asignado";
                    empleados[empleado] = (empleados[empleado] || 0) + 1;
                    contador++;
                }
            });
            
            console.log("Empleados procesados:", contador, "registros");
            return empleados;
        }

        function procesarPorAudiencias() {
            const audiencias = { 'Total de Audiencias': 0 };
            let contador = 0;
            
            [...causasData, ...miscausasData].forEach(doc => {
                if (doc.audiencias && Array.isArray(doc.audiencias)) {
                    doc.audiencias.forEach(audiencia => {
                        const fechaRef = audiencia.fecha || audiencia.fechaHora;
                        const fechaInfo = obtenerMesYAnio(fechaRef);
                        
                        if (filtroFecha(fechaInfo)) {
                            audiencias['Total de Audiencias']++;
                            contador++;
                        }
                    });
                }
            });
            
            console.log("Audiencias procesadas:", contador);
            return audiencias;
        }

        function procesarPorVencimientos() {
            const vencimientos = { 'Total de Vencimientos': 0 };
            let contador = 0;
            
            [...causasData, ...miscausasData].forEach(doc => {
                if (doc.vencimientos && Array.isArray(doc.vencimientos)) {
                    doc.vencimientos.forEach(vencimiento => {
                        const fechaInfo = obtenerMesYAnio(vencimiento.fecha);
                        
                        if (filtroFecha(fechaInfo)) {
                            vencimientos['Total de Vencimientos']++;
                            contador++;
                        }
                    });
                }
            });
            
            console.log("Vencimientos procesados:", contador);
            return vencimientos;
        }

        function procesarPorActividades() {
            const actividades = { 'Total de Actividades': 0 };
            let contador = 0;
            
            // Procesar causas
            causasData.forEach(causa => {
                if (causa.otrasActividades && Array.isArray(causa.otrasActividades)) {
                    const fechaInfo = obtenerMesYAnio(causa.fechaActualizacion);
                    
                    if (filtroFecha(fechaInfo)) {
                        actividades['Total de Actividades'] += causa.otrasActividades.length;
                        contador += causa.otrasActividades.length;
                    }
                }
            });
            
            // Procesar miscausas
            miscausasData.forEach(causa => {
                if (causa.actividades && Array.isArray(causa.actividades)) {
                    const fechaInfo = obtenerMesYAnio(causa.fechaActualizacion);
                    
                    if (filtroFecha(fechaInfo)) {
                        actividades['Total de Actividades'] += causa.actividades.length;
                        contador += causa.actividades.length;
                    }
                }
            });
            
            console.log("Actividades procesadas:", contador);
            return actividades;
        }

        function procesarPorCausas() {
            const causas = {};
            let contador = 0;
            
            [...causasData, ...miscausasData].forEach(doc => {
                const fechaRef = doc.fechaActualizacion || doc.fechaHora || new Date().toISOString();
                const fechaInfo = obtenerMesYAnio(fechaRef);
                
                if (filtroFecha(fechaInfo)) {
                    const tipo = doc.tipoProceso || "Otros";
                    causas[tipo] = (causas[tipo] || 0) + 1;
                    contador++;
                }
            });
            
            console.log("Tipos de proceso procesados:", contador);
            return causas;
        }

        function procesarPorControl() {
            const controles = {};
            let contador = 0;
            
            [...causasData, ...miscausasData].forEach(doc => {
                const fechaRef = doc.fechaActualizacion || doc.fechaHora || new Date().toISOString();
                const fechaInfo = obtenerMesYAnio(fechaRef);
                
                if (filtroFecha(fechaInfo)) {
                    const modo = doc.modoIntervencion || "Sin definir";
                    controles[modo] = (controles[modo] || 0) + 1;
                    contador++;
                }
            });
            
            console.log("Modos de intervención procesados:", contador);
            return controles;
        }

        function procesarPorPrioridades() {
            const prioridades = {};
            let contador = 0;
            
            miscausasData.forEach(doc => {
                const fechaRef = doc.fechaActualizacion || doc.fechaHora || new Date().toISOString();
                const fechaInfo = obtenerMesYAnio(fechaRef);
                
                if (filtroFecha(fechaInfo) && doc.prioridadTarea) {
                    let prioridad = doc.prioridadTarea;
                    
                    // Normalizar prioridades
                    if (typeof prioridad === 'string') {
                        if (prioridad.toLowerCase().includes('alta')) prioridad = 'Alta';
                        else if (prioridad.toLowerCase().includes('media')) prioridad = 'Media';
                        else if (prioridad.toLowerCase().includes('baja')) prioridad = 'Baja';
                        else if (prioridad.toLowerCase().includes('urgente')) prioridad = 'Urgente';
                        else if (prioridad === '') prioridad = 'Sin prioridad';
                    }
                    
                    prioridades[prioridad] = (prioridades[prioridad] || 0) + 1;
                    contador++;
                }
            });
            
            console.log("Prioridades procesadas:", contador);
            return prioridades;
        }

        function procesarPorFirmaDigital() {
            const firmas = { 'Firma Secretario': 0, 'Firma Defensor': 0, 'Sin Firma': 0 };
            let contador = 0;
            
            miscausasData.forEach(doc => {
                const fechaRef = doc.fechaActualizacion || doc.fechaHora || new Date().toISOString();
                const fechaInfo = obtenerMesYAnio(fechaRef);
                
                if (filtroFecha(fechaInfo)) {
                    contador++;
                    
                    if (doc.firmaDigital && Array.isArray(doc.firmaDigital) && doc.firmaDigital.length > 0) {
                        // Verificar si hay firma de secretario o defensor
                        const firmaStr = JSON.stringify(doc.firmaDigital).toLowerCase();
                        
                        if (firmaStr.includes('secretario') || firmaStr.includes('secretaria')) {
                            firmas['Firma Secretario']++;
                        } else if (firmaStr.includes('defensor') || firmaStr.includes('defensora')) {
                            firmas['Firma Defensor']++;
                        } else {
                            // Si hay firma pero no identificamos el tipo
                            firmas['Firma Defensor']++;
                        }
                    } else {
                        firmas['Sin Firma']++;
                    }
                }
            });
            
            console.log("Firmas digitales procesadas:", contador);
            return firmas;
        }

        function procesarPorClientes() {
            return { 'Total de Clientes': clientesData.length };
        }

        function mostrarEstadisticas(estadisticas) {
            console.log("Mostrando estadísticas en la interfaz");
            const grid = document.getElementById('statsGrid');
            grid.innerHTML = '';
            
            Object.keys(estadisticas).forEach((categoria, index) => {
                const datos = estadisticas[categoria];
                const labels = Object.keys(datos);
                const data = Object.values(datos);
                const total = data.reduce((a, b) => a + b, 0);
                
                const idCanvas = `canvas-${categoria.replace(/\s+/g, '')}`;
                const card = document.createElement('div');
                card.className = 'chart-card';
                card.innerHTML = `
                    <div class="chart-header">
                        <h3>${categoria}</h3>
                        <span class="chart-total" id="total-${idCanvas}">${total}</span>
                    </div>
                    <div class="chart-container"><canvas id="${idCanvas}"></canvas></div>
                `;
                grid.appendChild(card);
                
                crearGrafico(idCanvas, labels, data, categoria);
            });
            
            // Si no hay datos, mostrar mensaje
            const totalGeneral = Object.values(estadisticas).reduce((total, categoria) => {
                return total + Object.values(categoria).reduce((sum, val) => sum + val, 0);
            }, 0);
            
            if (totalGeneral === 0) {
                grid.innerHTML = '<div class="chart-card" style="text-align: center; padding: 40px;"><h3>No hay datos para los filtros seleccionados</h3><p>Intenta cambiar los filtros de mes y año</p></div>';
            }
        }

        function crearGrafico(canvasId, labels, data, categoria) {
            if (charts[canvasId]) {
                charts[canvasId].destroy();
            }
            
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            // Determinar el tipo de gráfico
            let tipoGrafico = chartType === 'circular' ? 'doughnut' : 'bar';
            
            // Si solo hay un dato y es gráfico circular, usar pie
            if (tipoGrafico === 'doughnut' && data.length === 1) {
                tipoGrafico = 'pie';
            }
            
            // Generar colores
            const colores = [];
            for (let i = 0; i < labels.length; i++) {
                colores.push(colorPalette[i % colorPalette.length]);
            }
            
            charts[canvasId] = new Chart(ctx, {
                type: tipoGrafico,
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colores,
                        borderColor: tipoGrafico === 'bar' ? '#2c3e50' : 'transparent',
                        borderWidth: tipoGrafico === 'bar' ? 1 : 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: 'right', 
                            display: labels.length > 1 && labels.length <= 10
                        },
                        datalabels: {
                            color: tipoGrafico === 'bar' ? '#2c3e50' : '#fff',
                            font: { weight: 'bold' },
                            formatter: (val) => val > 0 ? val : ''
                        }
                    },
                    scales: tipoGrafico === 'bar' ? {
                        y: { beginAtZero: true }
                    } : {}
                },
                plugins: [ChartDataLabels]
            });
        }

        function actualizarGraficos() {
            console.log("Actualizando gráficos con mes:", globalMonth, "año:", globalYear);
            procesarYMostrarDatos();
        }

        function generarContenidoImpresion() {
            let contenido = '';
            
            const mesSeleccionado = document.getElementById('globalMonthSelector').options[document.getElementById('globalMonthSelector').selectedIndex].text;
            const anioSeleccionado = document.getElementById('globalYearSelector').options[document.getElementById('globalYearSelector').selectedIndex].text;
            
            contenido += `<p><strong>Período:</strong> ${mesSeleccionado} ${anioSeleccionado}</p>`;
            contenido += `<p><strong>Fecha de generación:</strong> ${new Date().toLocaleDateString('es-ES')}</p>`;
            
            Object.keys(currentStats).forEach(categoria => {
                const datos = currentStats[categoria];
                const total = Object.values(datos).reduce((sum, val) => sum + val, 0);
                
                contenido += `
                    <div class="print-section">
                        <h3>${categoria} (Total: ${total})</h3>
                        <table class="print-table">
                            <thead><tr><th>Descripción</th><th>Cantidad</th></tr></thead>
                            <tbody>`;
                
                Object.keys(datos).forEach(item => {
                    contenido += `<tr><td>${item}</td><td>${datos[item]}</td></tr>`;
                });
                
                contenido += `</tbody></table></div>`;
            });
            
            return contenido;
        }

        function mostrarModalImpresion() {
            const printModal = document.getElementById('printModal');
            const printData = document.getElementById('printData');
            
            printData.innerHTML = generarContenidoImpresion();
            printModal.style.display = 'block';
        }

        // Eventos
        document.getElementById('globalMonthSelector').onchange = function() {
            globalMonth = parseInt(this.value);
            actualizarGraficos();
        };
        
        document.getElementById('globalYearSelector').onchange = function() {
            globalYear = parseInt(this.value);
            actualizarGraficos();
        };
        
        document.querySelectorAll('.chart-type-btn').forEach(btn => {
            btn.onclick = function() {
                document.querySelectorAll('.chart-type-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                chartType = this.dataset.type;
                actualizarGraficos();
            };
        });

        document.getElementById('printBtn').onclick = mostrarModalImpresion;
        document.getElementById('closePrintModal').onclick = function() {
            document.getElementById('printModal').style.display = 'none';
        };
        document.getElementById('cancelPrint').onclick = function() {
            document.getElementById('printModal').style.display = 'none';
        };
        document.getElementById('doPrint').onclick = function() {
            window.print();
        };

        window.onclick = function(event) {
            const printModal = document.getElementById('printModal');
            if (event.target === printModal) {
                printModal.style.display = 'none';
            }
        };

        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM cargado, iniciando aplicación...");
            cargarDatos();
        });
    </script>
</body>
</html>
